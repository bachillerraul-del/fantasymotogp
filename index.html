<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoGP™ Fantasy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-background: #0A0A0A;
            --color-surface: #1A1A1A;
            --color-border: #2F2F2F;
            --color-text-primary: #E0E0E0;
            --color-text-secondary: #888888;
            --color-accent: #00F2FF;
            --color-accent-danger: #FF1800;
        }

        html.light-mode {
            --color-background: #F5F5F5;
            --color-surface: #FFFFFF;
            --color-border: #E0E0E0;
            --color-text-primary: #0A0A0A;
            --color-text-secondary: #666666;
            --color-accent: #007BFF;
            --color-accent-danger: #DC3545;
        }

        body{font-family:'Roboto Mono',monospace;background-color:var(--color-background);color:var(--color-text-primary);overflow-x:hidden; transition: background-color 0.3s, color 0.3s;}
        body::before{content:" ";display:block;position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(128,128,128,0.05) 1px,transparent 1px);background-size:1px 3px;z-index:-1;pointer-events:none;opacity:0.5}
        .font-orbitron{font-family:'Orbitron',sans-serif}
        .fade-in{animation:fadeIn .5s ease-in-out forwards;opacity:0}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:var(--color-surface)}
        ::-webkit-scrollbar-thumb{background:var(--color-border);border-radius:4px}
        ::-webkit-scrollbar-thumb:hover{background:var(--color-accent)}
        .card-hover-effect:hover{box-shadow:0 0 15px var(--color-accent),inset 0 0 0 1px var(--color-accent)}
        .budget-green{color:#4ade80}
        .budget-yellow{color:#facc15}
        .budget-red{color:#f87171}
        #loader{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--color-background);display:flex;justify-content:center;align-items:center;z-index:100;color:var(--color-accent);font-family:'Orbitron',sans-serif;font-size:1.5rem;flex-direction:column;gap:1rem;transition:opacity .5s ease}
        .spinner{border:4px solid var(--color-border);border-top:4px solid var(--color-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #team-name-input, .result-selector { background-color: var(--color-background); border: 1px solid var(--color-border); color: var(--color-text-primary); }
        #team-name-input:focus, .result-selector:focus { border-color: var(--color-accent); box-shadow: 0 0 10px var(--color-accent); outline: none; }
    </style>
</head>
<body class="antialiased">

    <div id="loader"><div class="spinner"></div><p id="loader-text">INICIANDO SESIÓN...</p></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col items-end space-y-2"></div>

    <header class="bg-[var(--color-surface)]/80 backdrop-blur-sm border-b border-[var(--color-border)] sticky top-0 z-40">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div id="connection-status" class="w-3 h-3 rounded-full bg-gray-500 transition-colors duration-500" title="Desconectado"></div>
                <div class="text-xl font-bold font-orbitron tracking-wider">
                    <span class="text-[var(--color-accent)]">MOTO</span><span class="text-[var(--color-text-primary)]">GP</span><span class="text-sm"> FANTASY</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center space-x-6 text-sm">
                    <a href="#create" class="nav-link hover:text-[var(--color-accent)] transition-colors duration-200">Crear Equipo</a>
                    <a href="#teams" class="nav-link hover:text-[var(--color-accent)] transition-colors duration-200">Equipos</a>
                    <a href="#rules" class="nav-link hover:text-[var(--color-accent)] transition-colors duration-200">Reglas</a>
                    <a href="#results" class="nav-link hover:text-[var(--color-accent)] transition-colors duration-200">Resultados GP</a>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--color-border)] transition-colors">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414-2.12a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                </button>
            </div>
            <div class="md:hidden">
                <select id="mobile-nav" class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--color-accent)]">
                    <option value="create">Crear Equipo</option><option value="teams">Equipos</option><option value="rules">Reglas</option><option value="results">Resultados GP</option>
                </select>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6 pb-24">
        <div id="gp-selector-container" class="mb-6">
            <label for="gp-selector" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Selecciona un Gran Premio:</label>
            <select id="gp-selector" class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-md p-3 text-[var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] transition-all duration-200"></select>
        </div>

        <section id="page-create" class="page-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold mb-4 text-[var(--color-accent)] font-orbitron">Lista de Pilotos</h2>
                    <div id="pilot-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                <div class="lg:sticky top-24 h-fit">
                    <div id="my-team-panel" class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg p-4">
                        <h2 class="text-xl font-bold mb-2 text-[var(--color-accent)] font-orbitron">Mi Equipo</h2>
                        <input id="team-name-input" type="text" placeholder="Nombre de tu equipo..." class="w-full p-2 rounded-md font-bold transition-all duration-200 mb-1">
                        <p id="team-update-time" class="text-xs text-[var(--color-text-secondary)] h-4 mb-3"></p>
                        <div class="mb-4"><p class="text-[var(--color-text-secondary)] text-sm">Presupuesto Restante</p><p id="budget-display" class="text-4xl font-bold font-orbitron transition-colors duration-300"></p></div>
                        <div id="team-slots" class="space-y-2 mb-4"></div>
                        <button id="share-team-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-all duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            Compartir Equipo
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-teams" class="page-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-accent)] font-orbitron">Clasificación de Equipos</h2>
                <button id="share-classification-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                    Compartir Clasificación
                </button>
            </div>
            <div id="fantasy-teams-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
        
        <section id="page-rules" class="page-content hidden">
            <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg p-6 max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-[var(--color-accent)] font-orbitron">Reglas del Juego</h2>
                <div class="space-y-8 text-[var(--color-text-secondary)]">
                    <div>
                        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-2 border-b border-[var(--color-border)] pb-1">1. Objetivo del Juego</h3>
                        <p>El objetivo es crear un equipo de 5 pilotos de MotoGP para cada Gran Premio, acumulando la mayor cantidad de puntos posible. Tu habilidad para gestionar el presupuesto y elegir a los pilotos en mejor forma será clave para la victoria.</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-2 border-b border-[var(--color-border)] pb-1">2. Creación de tu Equipo</h3>
                        <ul class="list-disc list-inside space-y-2 pl-2">
                            <li><strong class="text-[var(--color-accent)]">Reset por Gran Premio:</strong> Tu presupuesto y tu equipo se reinician completamente después de cada carrera. ¡Cada GP es una nueva oportunidad para ganar!</li>
                            <li><strong class="text-[var(--color-accent)]">Presupuesto:</strong> Dispones de un presupuesto inicial de <span class="font-orbitron" id="rules-budget">100M</span> para cada evento.</li>
                            <li><strong class="text-[var(--color-accent)]">Precios Dinámicos:</strong> El valor de los pilotos puede variar ligeramente de una carrera a otra según su rendimiento. ¡Fíjate bien antes de fichar!</li>
                            <li><strong class="text-[var(--color-accent)]">Composición:</strong> Tu equipo debe estar formado por exactamente <span class="font-orbitron">5</span> pilotos.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-2 border-b border-[var(--color-border)] pb-1">3. Plazos de Entrega (Deadline)</h3>
                        <p>Para maximizar tus puntos, es crucial que envíes tu equipo a tiempo.</p>
                        <ul class="list-disc list-inside space-y-2 pl-2 mt-2">
                            <li><strong class="text-green-500">Puntuación Completa:</strong> Debes registrar tu equipo <strong class="underline">antes del comienzo de la Carrera Sprint</strong> del sábado. Si lo haces, puntuarás tanto en el Sprint como en la Carrera Principal del domingo.</li>
                            <li><strong class="text-yellow-500">Puntuación Parcial:</strong> Si registras tu equipo <strong class="underline">después del Sprint pero antes de la Carrera Principal</strong>, no sumarás los puntos del Sprint, pero todavía podrás puntuar en la carrera del domingo.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-2 border-b border-[var(--color-border)] pb-1">4. Sistema de Puntuación</h3>
                        <p>Los pilotos suman puntos en los dos eventos del fin de semana. El total de tu equipo es la suma de los puntos de tus 5 pilotos.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="bg-[var(--color-background)] p-4 rounded-md border border-[var(--color-border)]"><h4 class="font-bold text-center text-[var(--color-accent)]">Carrera Sprint (S)</h4><ul class="mt-2 space-y-1 text-sm"><li>P1: <span class="font-orbitron">12</span> pts</li><li>P2: <span class="font-orbitron">9</span> pts</li><li>P3: <span class="font-orbitron">7</span> pts</li><li>P4: <span class="font-orbitron">6</span> pts</li><li>P5: <span class="font-orbitron">5</span> pts</li><li>P6: <span class="font-orbitron">4</span> pts</li><li>P7: <span class="font-orbitron">3</span> pts</li><li>P8: <span class="font-orbitron">2</span> pts</li><li>P9: <span class="font-orbitron">1</span> pt</li></ul></div><div class="bg-[var(--color-background)] p-4 rounded-md border border-[var(--color-border)]"><h4 class="font-bold text-center text-[var(--color-accent)]">Carrera Principal (C)</h4><ul class="mt-2 space-y-1 text-sm"><li>P1: <span class="font-orbitron">25</span> pts</li><li>P2: <span class="font-orbitron">20</span> pts</li><li>P3: <span class="font-orbitron">16</span> pts</li><li>P4: <span class="font-orbitron">13</span> pts</li><li>P5: <span class="font-orbitron">11</span> pts</li><li>P6 - P15: <span class="font-orbitron">10</span> a <span class="font-orbitron">1</span> pt</li></ul></div></div>
                        <div class="mt-6"><h4 class="font-bold text-[var(--color-text-primary)] mb-2">Desempates</h4><p>En caso de empate a puntos en la clasificación, el ganador se decidirá siguiendo estos criterios en orden:</p><ol class="list-decimal list-inside space-y-1 pl-2 mt-2 text-sm"><li>El equipo cuyo piloto haya conseguido la mejor posición en la Carrera Principal.</li><li>Si persiste el empate, se comparará la posición del segundo mejor piloto de cada equipo, y así sucesivamente hasta deshacer el empate.</li></ol></div>
                        <div class="mt-6"><h4 class="font-bold text-[var(--color-text-primary)] mb-2">Regla Anticopia</h4><p>La originalidad tiene premio. Si dos o más participantes registran un equipo con los <strong class="text-[var(--color-accent)]">5 pilotos idénticos</strong>, se aplicará una penalización:</p><p class="bg-red-900/30 border border-red-500/50 p-3 mt-2 rounded-md text-sm">El participante que haya registrado el equipo más tarde recibirá una penalización de <strong class="font-orbitron">-5 puntos</strong> sobre su puntuación total para ese Gran Premio.</p></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-results" class="page-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-[var(--color-accent)] font-orbitron">Resultados Sprint</h2>
                    <div id="sprint-results" class="space-y-2"></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-[var(--color-accent)] font-orbitron">Resultados Carrera</h2>
                    <div id="race-results" class="space-y-2"></div>
                </div>
            </div>
            <div class="mt-8">
                <h2 class="text-2xl font-bold mb-4 text-[var(--color-accent)] font-orbitron">Puntuación Total del GP</h2>
                <div id="total-gp-scores" class="space-y-2"></div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://vjgrqksocpyhxhrqyjmm.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqZ3Jxa3NvY3B5aHhocnF5am1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTEyMzgsImV4cCI6MjA3MTI2NzIzOH0.4F1yvdh4AZCmCeOE_jeL9-R_DHcM6ICJUJUG5U5jN8A';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const SPRINT_POINTS = {1:12,2:9,3:7,4:6,5:5,6:4,7:3,8:2,9:1};
            const RACE_POINTS = {1:25,2:20,3:16,4:13,5:11,6:10,7:9,8:8,9:7,10:6,11:5,12:4,13:3,14:2,15:1};

            let state = {currentPage:'create',selectedGP:null,myTeam:[],pilots:[],initialBudget:100.0,gpResultsCache:{},user:null,isOnline:navigator.onLine,teamsCache:{},grandPrixs:[],currentClassification:[]};

            const loader=document.getElementById('loader'),loaderText=document.getElementById('loader-text'),pages=document.querySelectorAll('.page-content'),navLinks=document.querySelectorAll('.nav-link'),mobileNav=document.getElementById('mobile-nav'),gpSelector=document.getElementById('gp-selector'),pilotListContainer=document.getElementById('pilot-list'),budgetDisplay=document.getElementById('budget-display'),teamSlotsContainer=document.getElementById('team-slots'),shareTeamBtn=document.getElementById('share-team-btn'),fantasyTeamsGrid=document.getElementById('fantasy-teams-grid'),sprintResultsContainer=document.getElementById('sprint-results'),raceResultsContainer=document.getElementById('race-results'),rulesBudgetSpan=document.getElementById('rules-budget'),connectionStatus=document.getElementById('connection-status'),teamNameInput=document.getElementById('team-name-input'),teamUpdateTime=document.getElementById('team-update-time'),shareClassificationBtn=document.getElementById('share-classification-btn'),themeToggle=document.getElementById('theme-toggle'),themeIconSun=document.getElementById('theme-icon-sun'),themeIconMoon=document.getElementById('theme-icon-moon'),totalGpScoresContainer=document.getElementById('total-gp-scores');

            const navigateTo=pageId=>{state.currentPage=pageId;pages.forEach(p=>p.classList.add('hidden'));const targetPage=document.getElementById(`page-${pageId}`);if(targetPage){targetPage.classList.remove('hidden');targetPage.classList.add('fade-in')}navLinks.forEach(link=>{link.classList.toggle('text-[var(--color-accent)]',link.getAttribute('href')===`#${pageId}`)});mobileNav.value=pageId;renderCurrentPage()};
            const renderCurrentPage=async()=>{switch(state.currentPage){case'create':updateTeamPanelUI();renderPilotList();renderMyTeamPanel();break;case'teams':await renderFantasyTeams();break;case'results':await renderGPResults();break;case'rules':rulesBudgetSpan.textContent=`${state.initialBudget}M`;break}};
            const renderPilotList=()=>{pilotListContainer.innerHTML='';state.pilots.forEach(pilot=>{const isSelected=state.myTeam.includes(pilot.id),budget=calculateBudget(),canAfford=pilot.price<=budget,teamFull=state.myTeam.length>=5;const card=document.createElement('div');card.className=`bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg p-4 flex flex-col transition-all duration-200 ${isSelected?'opacity-50':'card-hover-effect'}`;card.innerHTML=`<div class="flex-grow"><div class="flex justify-between items-start"><div><p class="font-bold text-[var(--color-text-primary)] text-lg">${pilot.name}</p><p class="text-xs text-[var(--color-text-secondary)]">${pilot.team}</p></div><div class="text-2xl font-bold text-[var(--color-accent-danger)] font-orbitron">#${pilot.number}</div></div></div><div class="flex justify-between items-center mt-4"><p class="text-xl font-bold text-[var(--color-accent)] font-orbitron">${pilot.price.toFixed(1)}M</p><button class="add-pilot-btn bg-[var(--color-accent)] text-[var(--color-background)] text-sm font-bold py-1 px-3 rounded-md hover:bg-opacity-80 transition-all duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed" data-pilot-id="${pilot.id}" ${isSelected||!canAfford||teamFull?'disabled':''}>${isSelected?'Añadido':'Añadir'}</button></div>`;pilotListContainer.appendChild(card)})};
            const renderMyTeamPanel=()=>{const budget=calculateBudget();budgetDisplay.textContent=`${budget.toFixed(1)}M`;budgetDisplay.classList.remove('budget-green','budget-yellow','budget-red');if(budget>state.initialBudget*.4){budgetDisplay.classList.add('budget-green')}else if(budget>state.initialBudget*.15){budgetDisplay.classList.add('budget-yellow')}else{budgetDisplay.classList.add('budget-red')}teamSlotsContainer.innerHTML='';for(let i=0;i<5;i++){const slot=document.createElement('div');slot.className='bg-[var(--color-background)] border border-[var(--color-border)] rounded-md p-2 flex items-center justify-between h-12';if(state.myTeam[i]){const pilot=getPilotById(state.myTeam[i]);slot.innerHTML=`<div class="flex items-center"><span class="font-orbitron text-sm text-[var(--color-accent-danger)] w-8">#${pilot.number}</span><span class="text-sm">${pilot.name}</span></div><button class="remove-pilot-btn text-[var(--color-text-secondary)] hover:text-red-500 transition-colors" data-pilot-id="${pilot.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`}else{slot.innerHTML=`<span class="text-sm text-[var(--color-text-secondary)]">Slot Vacío</span>`}teamSlotsContainer.appendChild(slot)}shareTeamBtn.disabled=state.myTeam.length!==5};
            const updateTeamPanelUI=()=>{const team=state.teamsCache[state.selectedGP];teamNameInput.value=team?.team_name||'';teamUpdateTime.textContent=team?.updated_at?`Guardado: ${formatTimestamp(team.updated_at)}`:'';state.myTeam=team?.pilot_ids||[];renderMyTeamPanel()};
            const renderFantasyTeams=async()=>{fantasyTeamsGrid.innerHTML='<div class="spinner col-span-full mx-auto"></div>';const results=await getOrGenerateGPResults(state.selectedGP);const teams=await fetchFantasyTeams(state.selectedGP);fantasyTeamsGrid.innerHTML='';if(teams.length===0){fantasyTeamsGrid.innerHTML='<p class="text-[var(--color-text-secondary)] col-span-full text-center">Aún no hay equipos para este Gran Premio. ¡Sé el primero!</p>';state.currentClassification=[];shareClassificationBtn.disabled = true;return}const scoredTeams=teams.map(team=>{let totalPoints=0;const scoredPilots=team.pilot_ids.map(pilotId=>{const pilot=getPilotById(pilotId);if(!pilot)return null;const score=calculatePilotScore(pilotId,results);totalPoints+=score.total;return{...pilot,score}}).filter(p=>p!==null);scoredPilots.sort((a,b)=>b.score.total-a.score.total);return{name:team.team_name,totalPoints,scoredPilots,updated_at:team.updated_at}});scoredTeams.sort((a,b)=>{if(b.totalPoints!==a.totalPoints){return b.totalPoints-a.totalPoints}const getRacePositions=team=>team.scoredPilots.map(p=>p.score.racePos==='-'?Infinity:p.score.racePos).sort((x,y)=>x-y);const aPositions=getRacePositions(a);const bPositions=getRacePositions(b);for(let i=0;i<Math.min(aPositions.length,bPositions.length);i++){if(aPositions[i]!==bPositions[i]){return aPositions[i]-bPositions[i]}}return 0});state.currentClassification=scoredTeams;shareClassificationBtn.disabled = false;scoredTeams.forEach(team=>{const card=document.createElement('div');card.className='bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg p-4 flex flex-col';let pilotsHtml=team.scoredPilots.map(p=>`<div class="flex justify-between items-center text-sm py-1 border-b border-[var(--color-border)] last:border-b-0"><div><p class="font-semibold">${formatPilotName(p.name)} (${p.price.toFixed(1)}M)</p><p class="text-xs text-[var(--color-text-secondary)]">S: P${p.score.sprintPos} (${p.score.sprint} pts) / C: P${p.score.racePos} (${p.score.race} pts)</p></div><p class="font-bold font-orbitron text-base">${p.score.total} pts</p></div>`).join('');card.innerHTML=`<div class="flex-grow"><div class="flex justify-between items-start mb-3"><div><h3 class="text-lg font-bold">${team.name}</h3><p class="text-xs text-[var(--color-text-secondary)]">${formatTimestamp(team.updated_at)}</p></div><p class="text-2xl font-bold text-[var(--color-accent)] font-orbitron">${team.totalPoints} pts</p></div><div class="space-y-1">${pilotsHtml}</div></div>`;fantasyTeamsGrid.appendChild(card)})};
            const renderGPResults=async()=>{sprintResultsContainer.innerHTML='<div class="spinner mx-auto"></div>';raceResultsContainer.innerHTML='<div class="spinner mx-auto"></div>';totalGpScoresContainer.innerHTML='<div class="spinner mx-auto"></div>';const results=await getOrGenerateGPResults(state.selectedGP);sprintResultsContainer.innerHTML='';raceResultsContainer.innerHTML='';totalGpScoresContainer.innerHTML='';const pilotOptions='<option value="">-- Sin Asignar --</option>' + state.pilots.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');const createSelector=(position,pilotId)=>{const select=document.createElement('select');select.className='result-selector w-full p-2 rounded-md';select.innerHTML=pilotOptions;select.value=pilotId||'';return select};for(let i=0;i<9;i++){const pos=i+1;const pilotId=results.sprint_results[i];const points=SPRINT_POINTS[pos]||0;const row=document.createElement('div');row.className='flex items-center gap-2';row.innerHTML=`<span class="font-orbitron w-8 text-center">${pos}</span><span class="font-orbitron text-[var(--color-accent)] w-16 text-right pr-2">${points} pts</span>`;const selector=createSelector(pos,pilotId);selector.dataset.race='sprint';selector.dataset.position=i;row.appendChild(selector);sprintResultsContainer.appendChild(row)}for(let i=0;i<15;i++){const pos=i+1;const pilotId=results.race_results[i];const points=RACE_POINTS[pos]||0;const row=document.createElement('div');row.className='flex items-center gap-2';row.innerHTML=`<span class="font-orbitron w-8 text-center">${pos}</span><span class="font-orbitron text-[var(--color-accent)] w-16 text-right pr-2">${points} pts</span>`;const selector=createSelector(pos,pilotId);selector.dataset.race='race';selector.dataset.position=i;row.appendChild(selector);raceResultsContainer.appendChild(row)}const allPilotScores=state.pilots.map(pilot=>{const score=calculatePilotScore(pilot.id,results);return{name:pilot.name,total:score.total}}).sort((a,b)=>b.total-a.total);allPilotScores.forEach(pilotScore=>{const row=document.createElement('div');row.className='bg-[var(--color-surface)] border border-[var(--color-border)] rounded-md p-2 flex items-center justify-between text-sm';row.innerHTML=`<span>${pilotScore.name}</span><span class="font-bold font-orbitron text-[var(--color-accent)]">${pilotScore.total} pts</span>`;totalGpScoresContainer.appendChild(row)})};
            
            const debounce=(func,delay=1e3)=>{let timeout;return(...args)=>{clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),delay)}};
            const formatTimestamp=isoString=>new Date(isoString).toLocaleString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
            const formatPilotName=(fullName)=>{const parts=fullName.split(' ');if(parts.length<2)return fullName;const firstNameInitial=parts[0].charAt(0);const lastName=parts.slice(1).join(' ');return`${firstNameInitial}. ${lastName}`};
            const updateConnectionStatus=isOnline=>{state.isOnline=isOnline;connectionStatus.classList.toggle('bg-green-500',isOnline);connectionStatus.classList.toggle('bg-gray-500',!isOnline);connectionStatus.title=isOnline?'Conectado':'Modo Offline';if(isOnline)syncPendingSaves()};
            const fetchGrandPrixs=async()=>{if(!state.isOnline){const cached=localStorage.getItem('cachedGPs');if(cached)return JSON.parse(cached)}try{const{data,error}=await supabase.from('grand_prixs').select('name').order('sort_order',{ascending:!0});if(error)throw error;const gpNames=data.map(gp=>gp.name);localStorage.setItem('cachedGPs',JSON.stringify(gpNames));return gpNames}catch(error){console.error('Error al cargar Grandes Premios:',error);return JSON.parse(localStorage.getItem('cachedGPs')||'[]')}};
            const fetchPilots=async()=>{if(!state.isOnline){const cached=localStorage.getItem('cachedPilots');if(cached)return JSON.parse(cached)}try{const{data,error}=await supabase.from('pilots').select('*').order('price',{ascending:!1});if(error)throw error;localStorage.setItem('cachedPilots',JSON.stringify(data));return data}catch(error){console.error('Error al cargar los pilotos:',error);showToast('Error al cargar datos de pilotos','error');return JSON.parse(localStorage.getItem('cachedPilots')||'[]')}};
            const fetchSettings=async()=>{if(!state.isOnline){const cached=localStorage.getItem('cachedSettings');if(cached)return JSON.parse(cached)}try{const{data,error}=await supabase.from('settings').select('initial_budget').limit(1).single();if(error)throw error;localStorage.setItem('cachedSettings',JSON.stringify(data.initial_budget));return data.initial_budget}catch(error){console.error('Error al cargar el presupuesto:',error);showToast('Usando presupuesto por defecto','info');return JSON.parse(localStorage.getItem('cachedSettings')||'100')}};
            const fetchFantasyTeams=async gpName=>{if(!state.isOnline)return[];try{const{data,error}=await supabase.from('user_teams').select('team_name, pilot_ids, updated_at').eq('gp_name',gpName);if(error)throw error;return data}catch(error){console.error('Error al cargar equipos de fantasía:',error);showToast('Error al cargar la clasificación','error');return[]}};
            const loadMyTeamFromDB=async gpName=>{if(!state.user)return;if(state.teamsCache[gpName]){updateTeamPanelUI();return}if(!state.isOnline){const teams=JSON.parse(localStorage.getItem('cachedTeams')||'{}');state.teamsCache[gpName]=teams[gpName];updateTeamPanelUI();return}try{const{data,error}=await supabase.from('user_teams').select('pilot_ids, team_name, updated_at').eq('user_id',state.user.id).eq('gp_name',gpName).single();if(error&&error.code!=='PGRST116')throw error;state.teamsCache[gpName]=data;updateTeamPanelUI()}catch(error){console.error('Error cargando equipo:',error);state.teamsCache[gpName]=null;updateTeamPanelUI()}};
            const triggerAutoSave=()=>{if(teamNameInput.value.trim()!==''&&state.myTeam.length===5){debouncedSaveTeam()}else{if(teamUpdateTime.textContent.startsWith('Guardando')){teamUpdateTime.textContent=''}}};
            const saveMyTeamToDB=async()=>{if(!state.user)return;const teamData={user_id:state.user.id,gp_name:state.selectedGP,team_name:teamNameInput.value||'Mi Equipo Fantasía',pilot_ids:state.myTeam};state.teamsCache[state.selectedGP]=teamData;if(!state.isOnline){const pending=JSON.parse(localStorage.getItem('pendingSaves')||'{}');pending[state.selectedGP]=teamData;localStorage.setItem('pendingSaves',JSON.stringify(pending));teamUpdateTime.textContent='Guardado localmente...';showToast('Guardado localmente. Se sincronizará.','info');return}try{teamUpdateTime.textContent='Guardando...';const{data,error}=await supabase.from('user_teams').upsert(teamData,{onConflict:'user_id,gp_name'}).select().single();if(error)throw error;state.teamsCache[state.selectedGP]=data;teamUpdateTime.textContent=`Guardado: ${formatTimestamp(data.updated_at)}`;showToast('Equipo guardado en la nube','success')}catch(error){console.error('Error al guardar el equipo:',error);teamUpdateTime.textContent='Error al guardar';showToast('No se pudo guardar el equipo','error')}};
            const debouncedSaveTeam=debounce(saveMyTeamToDB);
            const saveGPResults=async()=>{const sprintResultNodes=document.querySelectorAll('#sprint-results select');const raceResultNodes=document.querySelectorAll('#race-results select');const sprint_results=Array.from(sprintResultNodes).map(s=>parseInt(s.value)||null);const race_results=Array.from(raceResultNodes).map(s=>parseInt(s.value)||null);const resultData={gp_name:state.selectedGP,sprint_results,race_results};state.gpResultsCache[state.selectedGP]=resultData;if(!state.isOnline){showToast('No se pueden guardar resultados offline.','error');return}try{const{error}=await supabase.from('gp_results').upsert(resultData,{onConflict:'gp_name'});if(error)throw error;showToast('Resultados guardados','success')}catch(error){console.error('Error guardando resultados:',error);showToast('Error al guardar resultados','error')}};
            const debouncedSaveResults=debounce(saveGPResults);
            const syncPendingSaves=async()=>{const pending=JSON.parse(localStorage.getItem('pendingSaves')||'{}');if(Object.keys(pending).length===0)return;showToast('Sincronizando cambios...','info');for(const gpName in pending){const teamData=pending[gpName];const{error}=await supabase.from('user_teams').upsert(teamData,{onConflict:'user_id,gp_name'});if(error){console.error(`Error sincronizando ${gpName}:`,error);showToast(`Error al sincronizar equipo de ${gpName}`,'error');return}}localStorage.removeItem('pendingSaves');showToast('¡Equipos sincronizados!','success')};
            const calculateBudget=()=>state.initialBudget-state.myTeam.reduce((total,pilotId)=>{const pilot=getPilotById(pilotId);return total+(pilot?pilot.price:0)},0);
            const getPilotById=id=>state.pilots.find(p=>p.id===id);
            const addPilot=pilotId=>{if(state.myTeam.length>=5){showToast('Equipo completo (5 pilotos máximo)','error');return}if(state.myTeam.includes(pilotId)){showToast('Este piloto ya está en tu equipo','error');return}const pilot=getPilotById(pilotId);if(calculateBudget()<pilot.price){showToast('Presupuesto insuficiente','error');return}state.myTeam.push(pilotId);renderPilotList();renderMyTeamPanel();triggerAutoSave()};
            const removePilot=pilotId=>{state.myTeam=state.myTeam.filter(id=>id!==pilotId);renderPilotList();renderMyTeamPanel();triggerAutoSave()};
            const getOrGenerateGPResults=async gpName=>{if(state.gpResultsCache[gpName])return state.gpResultsCache[gpName];if(state.isOnline){try{const{data,error}=await supabase.from('gp_results').select('*').eq('gp_name',gpName).single();if(data){state.gpResultsCache[gpName]=data;return data}if(error&&error.code!=='PGRST116')throw error}catch(err){console.error("Error fetching results, generating random.",err)}}const shuffledPilots=[...state.pilots].sort(()=>.5-Math.random()),sprint_results=shuffledPilots.slice(0,9).map(p=>p.id),shuffledAgain=[...state.pilots].sort(()=>.5-Math.random()),race_results=shuffledAgain.slice(0,15).map(p=>p.id),results={gp_name:gpName,sprint_results,race_results};state.gpResultsCache[gpName]=results;return results};
            const calculatePilotScore=(pilotId,gpResults)=>{const sprintPos=(gpResults.sprint_results||[]).indexOf(pilotId)+1,racePos=(gpResults.race_results||[]).indexOf(pilotId)+1,sprint=sprintPos>0?SPRINT_POINTS[sprintPos]||0:0,race=racePos>0?RACE_POINTS[racePos]||0:0;return{total:sprint+race,sprint,race,sprintPos:sprintPos||'-',racePos:racePos||'-'}};
            const showToast=(message,type='info')=>{const toastContainer=document.getElementById('toast-container'),toast=document.createElement('div'),colors={info:'bg-[#00F2FF] text-black',success:'bg-green-500 text-white',error:'bg-red-500 text-white'};toast.className=`px-4 py-2 rounded-md shadow-lg text-sm font-semibold ${colors[type]}`;toast.textContent=message;toast.style.opacity='0';toast.style.transform='translateX(100%)';toastContainer.appendChild(toast);toast.getBoundingClientRect();toast.style.transition='opacity .3s ease, transform .3s ease';toast.style.opacity='1';toast.style.transform='translateX(0)';setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateX(100%)';toast.addEventListener('transitionend',()=>toast.remove())},3e3)};
            const setTheme=theme=>{document.documentElement.classList.toggle('light-mode',theme==='light');themeIconSun.classList.toggle('hidden',theme==='dark');themeIconMoon.classList.toggle('hidden',theme==='light');localStorage.setItem('theme',theme)};
            
            navLinks.forEach(link=>link.addEventListener('click',e=>{e.preventDefault();navigateTo(e.target.getAttribute('href').substring(1))}));
            mobileNav.addEventListener('change',e=>navigateTo(e.target.value));
            pilotListContainer.addEventListener('click',e=>{if(e.target.classList.contains('add-pilot-btn'))addPilot(parseInt(e.target.dataset.pilotId))});
            document.getElementById('my-team-panel').addEventListener('click',e=>{const removeButton=e.target.closest('.remove-pilot-btn');if(removeButton)removePilot(parseInt(removeButton.dataset.pilotId))});
            gpSelector.addEventListener('change',async e=>{state.selectedGP=e.target.value;await loadMyTeamFromDB(state.selectedGP);renderCurrentPage()});
            teamNameInput.addEventListener('input', triggerAutoSave);
            document.getElementById('page-results').addEventListener('change',e=>{if(e.target.classList.contains('result-selector'))debouncedSaveResults()});
            shareClassificationBtn.addEventListener('click',()=>{if(state.currentClassification.length>0){let message=`¡Clasificación del ${state.selectedGP} en MotoGP Fantasy! 🚀\n\n`;state.currentClassification.forEach((team,index)=>{message+=`${index+1}. ${team.name} - ${team.totalPoints} pts\n`});const whatsappUrl=`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;window.open(whatsappUrl,'_blank')}else{showToast('No hay equipos en la clasificación para compartir.','info')}});
            shareTeamBtn.addEventListener('click',()=>{if(state.myTeam.length===5){const teamName=teamNameInput.value||'Mi Equipo Fantasía';const budget=calculateBudget();const totalCost=state.initialBudget-budget;const pilotsWithPrices=state.myTeam.map(id=>{const pilot=getPilotById(id);return`\n- ${pilot.name} (${pilot.price.toFixed(1)}M)`}).join('');const message=`¡Mi equipo "${teamName}" para el ${state.selectedGP}!\n🚀\nPilotos:${pilotsWithPrices}\n\nCoste Total: ${totalCost.toFixed(1)}M\nPresupuesto Restante: ${budget.toFixed(1)}M\n\n¡Crea el tuyo en MotoGP Fantasy!`;const whatsappUrl=`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;window.open(whatsappUrl,'_blank')}});
            window.addEventListener('online',()=>updateConnectionStatus(!0));
            window.addEventListener('offline',()=>updateConnectionStatus(!1));
            themeToggle.addEventListener('click',()=>{const newTheme=document.documentElement.classList.contains('light-mode')?'dark':'light';setTheme(newTheme)});

            const init=async()=>{
                const savedTheme=localStorage.getItem('theme')||'light';setTheme(savedTheme);
                if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').then(reg=>console.log('Service Worker registrado',reg)).catch(err=>console.log('Error al registrar Service Worker',err))}
                updateConnectionStatus(navigator.onLine);
                const{data:{session}}=await supabase.auth.getSession();if(session){state.user=session.user}else{const{data,error}=await supabase.auth.signInAnonymously();if(error){loaderText.textContent='Error de autenticación.';return}state.user=data.user}
                loaderText.textContent='CARGANDO DATOS...';
                const[pilotsData,settingsData,gpData]=await Promise.all([fetchPilots(),fetchSettings(),fetchGrandPrixs()]);
                state.pilots=pilotsData;state.initialBudget=settingsData;state.grandPrixs=gpData;
                if(state.pilots.length===0&&!navigator.onLine){loaderText.textContent='Necesitas conexión para el primer uso.';return}
                state.grandPrixs.forEach(gp=>{const option=document.createElement('option');option.value=gp;option.textContent=gp;gpSelector.appendChild(option)});
                state.selectedGP=gpSelector.value;
                await loadMyTeamFromDB(state.selectedGP);
                loader.style.opacity='0';setTimeout(()=>loader.style.display='none',500);
                const initialPage=window.location.hash.substring(1)||'create';navigateTo(initialPage)
            };
            init();
        });
    </script>
</body>
</html>
